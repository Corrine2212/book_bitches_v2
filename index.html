<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Book Bitches">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#c17f42">
<title>Book Bitches ğŸ“š</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,600;0,700;0,900;1,400;1,700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{height:100%;-webkit-tap-highlight-color:transparent;scroll-behavior:smooth}
body{font-family:'DM Sans',sans-serif;min-height:100%;background:var(--bg);color:var(--text);transition:background .35s,color .35s;overscroll-behavior:none}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEMES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root{
  --bg:#14110f;--bg2:#1c1814;--card:#221e1a;--card2:#2a2420;
  --border:#332e28;--text:#f0e8df;--text2:#b8a898;--text3:#7a6a5a;
  --accent:#c17f42;--accent-d:rgba(193,127,66,.15);--accent-g:rgba(193,127,66,.35);
  --nav:#1a1510;--input:#2a2420;--shadow:rgba(0,0,0,.55);--del:#e05c5c;--ok:#5aad6e;
}
body.light{
  --bg:#faf6f1;--bg2:#f2ebe0;--card:#fff;--card2:#f7f1eb;
  --border:#e4d8cc;--text:#2a1f14;--text2:#6b5540;--text3:#9a8878;
  --accent:#b5702e;--accent-d:rgba(181,112,46,.1);--accent-g:rgba(181,112,46,.3);
  --nav:#f2ebe0;--input:#ede4d9;--shadow:rgba(0,0,0,.1);
}
body.purple{
  --bg:#0f0c17;--bg2:#160f22;--card:#1e1530;--card2:#261b3a;
  --border:#362545;--text:#ede8f5;--text2:#b0a0cc;--text3:#7060a0;
  --accent:#a07de0;--accent-d:rgba(160,125,224,.15);--accent-g:rgba(160,125,224,.35);
  --nav:#130d1f;--input:#251a38;--shadow:rgba(0,0,0,.55);
}
body.green{
  --bg:#0c1410;--bg2:#111c15;--card:#17231b;--card2:#1e2e22;
  --border:#2a3d2e;--text:#e4f0e8;--text2:#90b898;--text3:#507858;
  --accent:#5aad6e;--accent-d:rgba(90,173,110,.15);--accent-g:rgba(90,173,110,.35);
  --nav:#0e1a12;--input:#1c2e20;--shadow:rgba(0,0,0,.55);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT SHELL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#shell{display:flex;min-height:100vh}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDEBAR â€” desktop only
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sidebar{
  display:none;width:220px;flex-shrink:0;background:var(--nav);
  border-right:1px solid var(--border);position:fixed;top:0;left:0;bottom:0;
  flex-direction:column;padding:28px 0 20px;z-index:40;transition:background .35s;
}
.sidebar-logo{
  font-family:'Playfair Display',serif;font-weight:900;font-size:19px;
  color:var(--text);padding:0 20px 24px;letter-spacing:-.02em;line-height:1.2;
}
.sidebar-logo em{color:var(--accent);font-style:normal;display:block;font-size:13px;font-weight:400;margin-top:2px}
.sidebar-nav{flex:1;display:flex;flex-direction:column;gap:2px;padding:0 10px}
.sidebar-btn{
  display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;
  background:none;border:none;color:var(--text3);cursor:pointer;font-family:inherit;
  font-size:13px;font-weight:500;transition:background .15s,color .15s;text-align:left;width:100%;position:relative;
}
.sidebar-btn:hover{background:var(--card2);color:var(--text)}
.sidebar-btn.active{background:var(--accent-d);color:var(--accent)}
.sidebar-btn svg{width:18px;height:18px;flex-shrink:0}
.sidebar-badge{margin-left:auto;background:var(--accent);color:#fff;font-size:10px;font-weight:700;min-width:18px;height:18px;border-radius:9px;display:none;align-items:center;justify-content:center;padding:0 5px}
.sidebar-badge.show{display:flex}
.sidebar-fab{margin:16px 10px 0;padding:12px;border-radius:10px;background:var(--accent);border:none;color:#fff;cursor:pointer;font-family:inherit;font-size:13px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:8px;transition:opacity .15s}
.sidebar-fab:hover{opacity:.88}
.sidebar-fab svg{width:16px;height:16px}
.sidebar-stats{padding:14px 20px 0;font-size:11px;color:var(--text3);border-top:1px solid var(--border);margin-top:auto;line-height:2}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main{flex:1;display:flex;flex-direction:column;min-width:0}

@media(min-width:800px){
  .sidebar{display:flex}
  .main{margin-left:220px}
  .bottom-nav,.fab{display:none!important}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.header{padding:18px 18px 0;background:var(--bg);position:sticky;top:0;z-index:30;border-bottom:1px solid transparent;transition:border-color .2s,box-shadow .2s,background .35s}
.header.scrolled{border-color:var(--border);box-shadow:0 4px 24px var(--shadow)}
.logo-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}
.logo{font-family:'Playfair Display',serif;font-weight:900;font-size:clamp(22px,5.5vw,30px);color:var(--text);letter-spacing:-.02em;line-height:1}
.logo em{color:var(--accent);font-style:normal}
@media(min-width:800px){.logo-row .logo{display:none}}
.stats-pill{font-size:11px;color:var(--text3);background:var(--card);border:1px solid var(--border);padding:4px 10px;border-radius:20px;letter-spacing:.04em;white-space:nowrap}
.search-wrap{padding:10px 0 12px;position:relative}
.search-icon{position:absolute;left:13px;top:50%;transform:translateY(-50%);color:var(--text3);pointer-events:none}
.search-input{width:100%;background:var(--input);border:1.5px solid var(--border);border-radius:24px;padding:10px 40px 10px 38px;color:var(--text);font-family:inherit;font-size:16px;outline:none;transition:border-color .2s;caret-color:var(--accent)}
.search-input:focus{border-color:var(--accent)}
.search-input::placeholder{color:var(--text3)}
.search-clear{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:var(--card2);border:none;color:var(--text3);cursor:pointer;width:24px;height:24px;border-radius:50%;display:none;align-items:center;justify-content:center;transition:color .15s,background .15s}
.search-clear.vis{display:flex}
.search-clear:hover{color:var(--text);background:var(--border)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOBILE BOTTOM NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--nav);border-top:1px solid var(--border);display:flex;z-index:50;padding-bottom:max(env(safe-area-inset-bottom),20px);transition:background .35s}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:15px 0 10px;background:none;border:none;cursor:pointer;color:var(--text3);transition:color .2s;font-family:inherit;position:relative}
.nav-btn.active{color:var(--accent)}
.nav-btn svg{width:21px;height:21px;transition:transform .2s}
.nav-btn.active svg{transform:scale(1.1)}
.nav-btn span{font-size:10px;font-weight:600;letter-spacing:.04em}
.nav-badge{position:absolute;top:6px;right:calc(50% - 18px);background:var(--accent);color:#fff;font-size:9px;font-weight:700;min-width:16px;height:16px;border-radius:8px;display:none;align-items:center;justify-content:center;padding:0 4px}
.nav-badge.show{display:flex}
.fab{position:fixed;bottom:calc(104px + max(env(safe-area-inset-bottom),20px));right:16px;width:54px;height:54px;border-radius:50%;background:var(--accent);border:none;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 22px var(--accent-g);z-index:45;transition:transform .18s,box-shadow .18s}
.fab:hover{transform:scale(1.1);box-shadow:0 6px 30px var(--accent-g)}
.fab:active{transform:scale(.94)}
.fab svg{width:24px;height:24px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONTENT & PAGES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.content{flex:1;padding:16px 16px calc(100px + max(env(safe-area-inset-bottom),20px))}
@media(min-width:800px){.content{padding:24px 28px 32px}}
.page{display:none}
.page.active{display:block;animation:fadeUp .22s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.section-head{margin-bottom:14px}
.section-title{font-family:'Playfair Display',serif;font-size:clamp(18px,4vw,26px);color:var(--text)}
.section-sub{font-size:12px;color:var(--text3);margin-top:3px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOK GRID â€” expands on desktop
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.books-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
@media(min-width:500px){.books-grid{grid-template-columns:repeat(4,1fr)}}
@media(min-width:800px){.books-grid{grid-template-columns:repeat(4,1fr);gap:16px}}
@media(min-width:1000px){.books-grid{grid-template-columns:repeat(5,1fr)}}
@media(min-width:1200px){.books-grid{grid-template-columns:repeat(6,1fr)}}

.book-card{background:var(--card);border-radius:10px;border:1px solid var(--border);overflow:hidden;cursor:pointer;transition:transform .18s,box-shadow .18s,border-color .18s;position:relative}
.book-card:hover{transform:translateY(-4px);box-shadow:0 12px 32px var(--shadow);border-color:var(--accent)}
.book-card:active{transform:scale(.97)}
.book-cover-wrap{width:100%;aspect-ratio:2/3;background:var(--card2);position:relative;overflow:hidden;display:block}
.book-cover-img{width:100%;height:100%;object-fit:cover;transition:opacity .3s;display:block;position:absolute;inset:0}
.book-cover-fallback{width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px;text-align:center;position:relative}
.spine-stripe{position:absolute;left:0;top:0;bottom:0;width:10px}
.fallback-title{font-family:'Playfair Display',serif;font-weight:700;font-size:clamp(9px,2.2vw,12px);color:var(--text);line-height:1.3;display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden;padding-left:14px;word-break:break-word}
.fallback-author{font-size:clamp(8px,1.8vw,10px);color:var(--text3);margin-top:4px;font-style:italic;padding-left:14px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.book-info{padding:8px 9px 10px}
.book-info-title{font-family:'Playfair Display',serif;font-weight:700;font-size:12px;color:var(--text);line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.book-info-author{font-size:10px;color:var(--accent);margin-top:2px;font-style:italic;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.book-info-date{font-size:9px;color:var(--text3);margin-top:3px}
.book-owner-dot{position:absolute;top:7px;right:7px;width:8px;height:8px;border-radius:50%;background:var(--accent);opacity:.9;border:1.5px solid var(--bg)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RECENT LIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.recent-list{display:flex;flex-direction:column;gap:8px}
.recent-item{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px 12px;display:flex;align-items:center;gap:10px;transition:transform .15s,border-color .15s;cursor:pointer}
.recent-item:hover{transform:translateX(4px);border-color:var(--accent)}
.recent-cover{width:42px;height:60px;border-radius:5px;background:var(--card2);flex-shrink:0;overflow:hidden;position:relative}
.recent-cover img{width:100%;height:100%;object-fit:cover}
.recent-spine-strip{position:absolute;left:0;top:0;bottom:0;width:5px;border-radius:4px 0 0 4px}
.recent-info{flex:1;min-width:0}
.recent-title{font-family:'Playfair Display',serif;font-weight:700;font-size:14px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.recent-author{font-size:12px;color:var(--text2);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.recent-note{font-size:11px;color:var(--text3);font-style:italic;margin-top:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.recent-meta{text-align:right;flex-shrink:0}
.recent-who{font-size:11px;color:var(--accent);font-weight:600}
.recent-date{font-size:10px;color:var(--text3);margin-top:2px}
.recent-btns{display:flex;gap:2px}
.icon-btn{background:none;border:none;color:var(--text3);cursor:pointer;padding:6px;border-radius:8px;transition:color .15s,background .15s;display:flex;align-items:center}
.icon-btn:hover{background:var(--card2);color:var(--text)}
.icon-btn.del:hover{color:var(--del);background:rgba(224,92,92,.08)}
.icon-btn svg{width:15px;height:15px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:flex-end;justify-content:center;z-index:100;opacity:0;pointer-events:none;transition:opacity .25s}
.overlay.open{opacity:1;pointer-events:all}
.modal{background:var(--bg);border-radius:22px 22px 0 0;padding:6px 20px max(24px,env(safe-area-inset-bottom));width:100%;max-width:700px;max-height:94vh;overflow-y:auto;transform:translateY(50px);border:1px solid var(--border);border-bottom:none;transition:transform .3s cubic-bezier(.34,1.2,.64,1)}
@media(min-width:600px){.overlay{align-items:center;padding:20px}.modal{border-radius:20px;border-bottom:1px solid var(--border);max-height:88vh}}
.overlay.open .modal{transform:translateY(0)}
.modal-handle{width:38px;height:4px;background:var(--border);border-radius:2px;margin:10px auto 18px}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.modal-title{font-family:'Playfair Display',serif;font-size:22px;color:var(--text)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.form-group{margin-bottom:14px}
.form-label{font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:.07em;margin-bottom:5px;display:block;font-weight:600}
.form-input{width:100%;background:var(--input);border:1.5px solid var(--border);border-radius:10px;padding:11px 13px;color:var(--text);font-family:inherit;font-size:16px;outline:none;transition:border-color .2s;caret-color:var(--accent)}
.form-input:focus{border-color:var(--accent)}
.form-input::placeholder{color:var(--text3)}
textarea.form-input{resize:vertical;min-height:72px}
.owner-toggle{display:flex;gap:8px}
.owner-btn{flex:1;padding:10px;border-radius:10px;border:1.5px solid var(--border);background:transparent;color:var(--text3);font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;transition:all .18s}
.owner-btn.active{border-color:var(--accent);background:var(--accent-d);color:var(--accent)}

/* â”€â”€ COVER PREVIEW in form â”€â”€ */
.cover-preview-wrap{
  display:flex;gap:12px;align-items:flex-start;
  background:var(--card2);border:1px solid var(--border);border-radius:12px;
  padding:12px;margin-bottom:16px;
}
.cover-preview-box{
  width:58px;height:86px;border-radius:7px;background:var(--input);
  border:1px solid var(--border);overflow:hidden;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;position:relative;font-size:22px;
}
.cover-preview-box img{width:100%;height:100%;object-fit:cover;position:absolute;inset:0}
.cover-preview-info{flex:1;min-width:0}
.cover-preview-booktitle{font-size:13px;font-weight:600;color:var(--text);margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cover-status-row{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text3)}
.cover-status-row.found{color:var(--ok)}
.cover-status-row.searching{color:var(--accent)}
.cover-status-row .mini-spinner{width:12px;height:12px;border:1.5px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0}
.cover-action-btns{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap}
.cover-tiny-btn{font-size:11px;color:var(--accent);background:none;border:none;cursor:pointer;padding:0;text-decoration:underline;font-family:inherit}
.cover-tiny-btn.muted{color:var(--text3)}

.submit-btn{width:100%;padding:14px;border-radius:10px;background:var(--accent);border:none;color:#fff;font-family:inherit;font-size:15px;font-weight:600;cursor:pointer;margin-top:6px;transition:opacity .15s,transform .1s}
.submit-btn:hover{opacity:.88}
.submit-btn:active{transform:scale(.98)}
.submit-btn:disabled{opacity:.4;cursor:not-allowed}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DETAIL MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.detail-cover-wrap{width:110px;height:165px;border-radius:10px;overflow:hidden;background:var(--card2);flex-shrink:0;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:32px;position:relative}
.detail-cover-wrap img{width:100%;height:100%;object-fit:cover}
.detail-hero{display:flex;gap:16px;align-items:flex-start;margin-bottom:20px}
.detail-info{flex:1;min-width:0;padding-top:4px}
.detail-title{font-family:'Playfair Display',serif;font-weight:700;font-size:20px;color:var(--text);line-height:1.3;margin-bottom:6px}
.detail-author{font-size:14px;color:var(--accent);font-style:italic;margin-bottom:8px}
.detail-meta{font-size:12px;color:var(--text3);margin-bottom:4px}
.detail-notes{font-size:13px;color:var(--text2);font-style:italic;line-height:1.6;padding:12px;background:var(--card2);border-radius:10px;border:1px solid var(--border);margin-bottom:16px}
.detail-actions{display:flex;gap:10px}
.detail-btn{flex:1;padding:11px;border-radius:10px;border:1.5px solid var(--border);background:transparent;color:var(--text);font-family:inherit;font-size:14px;cursor:pointer;transition:background .15s,border-color .15s;display:flex;align-items:center;justify-content:center;gap:6px}
.detail-btn:hover{background:var(--card2);border-color:var(--accent)}
.detail-btn.danger:hover{border-color:var(--del);color:var(--del);background:rgba(224,92,92,.08)}
.detail-btn svg{width:16px;height:16px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIRM MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.confirm-modal{background:var(--bg);border-radius:16px;padding:26px;max-width:360px;width:calc(100% - 32px);text-align:center;border:1px solid var(--border);transform:scale(.88);transition:transform .22s cubic-bezier(.34,1.4,.64,1)}
.overlay.open .confirm-modal{transform:scale(1)}
.confirm-icon{font-size:40px;margin-bottom:12px}
.confirm-title{font-family:'Playfair Display',serif;font-size:20px;color:var(--text);margin-bottom:6px}
.confirm-sub{font-size:13px;color:var(--text3);margin-bottom:22px;line-height:1.5}
.confirm-btns{display:flex;gap:10px}
.confirm-btn{flex:1;padding:12px;border-radius:10px;border:1.5px solid var(--border);background:transparent;color:var(--text);font-family:inherit;font-size:14px;cursor:pointer;transition:background .15s}
.confirm-btn:hover{background:var(--card2)}
.confirm-btn.danger{background:var(--del);border-color:var(--del);color:#fff;font-weight:600}
.confirm-btn.danger:hover{opacity:.88}

/* Dupes modal */
.dupe-modal{background:var(--bg);border-radius:22px 22px 0 0;padding:6px 20px max(24px,env(safe-area-inset-bottom));width:100%;max-width:700px;max-height:90vh;overflow-y:auto;transform:translateY(50px);border:1px solid var(--border);border-bottom:none;transition:transform .3s cubic-bezier(.34,1.2,.64,1)}
@media(min-width:600px){.dupe-modal{border-radius:20px;border-bottom:1px solid var(--border);max-height:85vh}}
.overlay.open .dupe-modal{transform:translateY(0)}
.dupe-group{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:12px}
.dupe-group-label{font-family:'Playfair Display',serif;font-size:15px;color:var(--text);margin-bottom:10px;font-weight:700}
.dupe-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);gap:12px}
.dupe-row:last-child{border-bottom:none;padding-bottom:0}
.dupe-row-info{flex:1;min-width:0}
.dupe-row-who{font-size:11px;color:var(--accent);font-weight:600}
.dupe-row-meta{font-size:10px;color:var(--text3);margin-top:1px}
.dupe-del-btn{background:rgba(224,92,92,.12);border:1px solid rgba(224,92,92,.3);color:var(--del);padding:5px 10px;border-radius:7px;font-size:12px;cursor:pointer;font-family:inherit;transition:background .15s;flex-shrink:0}
.dupe-del-btn:hover{background:rgba(224,92,92,.25)}
.no-dupes{text-align:center;padding:32px 20px;color:var(--text3);font-style:italic;font-size:14px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast{position:fixed;top:18px;left:50%;transform:translateX(-50%) translateY(-80px);background:var(--card);color:var(--text);border:1px solid var(--border);padding:10px 18px;border-radius:24px;font-size:13px;font-weight:500;z-index:200;box-shadow:0 6px 24px var(--shadow);white-space:nowrap;display:flex;align-items:center;gap:8px;transition:transform .32s cubic-bezier(.34,1.4,.64,1)}
.toast.show{transform:translateX(-50%) translateY(0)}
.toast-dot{width:8px;height:8px;border-radius:50%;background:var(--accent);flex-shrink:0}
.toast-dot.del{background:var(--del)}
.toast-dot.ok{background:var(--ok)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETTINGS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.settings-card{background:var(--card);border-radius:14px;border:1px solid var(--border);overflow:hidden;margin-bottom:14px}
.settings-row{padding:15px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:12px}
.settings-row:last-child{border-bottom:none}
.settings-row.col{flex-direction:column;align-items:flex-start}
.settings-label{font-size:14px;color:var(--text);font-weight:500}
.settings-sub{font-size:12px;color:var(--text3);margin-top:2px}
.theme-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;width:100%;margin-top:10px}
.theme-swatch{display:flex;flex-direction:column;align-items:center;gap:5px;cursor:pointer;padding:8px 4px;border-radius:10px;border:1.5px solid var(--border);transition:all .15s;background:var(--card2)}
.theme-swatch:hover,.theme-swatch.active{border-color:var(--accent);background:var(--accent-d)}
.swatch-dot{width:30px;height:30px;border-radius:50%;border:2px solid rgba(255,255,255,.08)}
.swatch-label{font-size:11px;color:var(--text2);font-weight:500}
.count-btns{display:flex;gap:6px}
.count-btn{padding:7px 16px;border-radius:8px;border:1.5px solid var(--border);background:transparent;color:var(--text3);font-family:inherit;font-size:14px;cursor:pointer;transition:all .15s}
.count-btn.active{border-color:var(--accent);background:var(--accent-d);color:var(--accent);font-weight:600}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;width:100%;margin-top:10px}
.stat-tile{background:var(--card2);border-radius:10px;padding:14px}
.stat-num{font-family:'Playfair Display',serif;font-size:26px;color:var(--accent);font-weight:700}
.stat-label{font-size:11px;color:var(--text3);margin-top:3px}
.action-btn{display:flex;align-items:center;gap:7px;padding:9px 14px;border-radius:9px;border:1.5px solid var(--border);background:transparent;color:var(--text);font-family:inherit;font-size:13px;cursor:pointer;transition:all .15s;font-weight:500}
.action-btn:hover{background:var(--card2);border-color:var(--accent);color:var(--accent)}
.action-btn.warn:hover{border-color:var(--del);color:var(--del);background:rgba(224,92,92,.08)}
.action-btn svg{width:15px;height:15px;flex-shrink:0}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MISC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.firebase-banner{background:rgba(224,92,92,.12);border:1px solid rgba(224,92,92,.3);border-radius:10px;padding:12px 14px;margin-bottom:14px;font-size:13px;color:var(--del);display:none;line-height:1.5}
.firebase-banner.show{display:block}
.empty{text-align:center;padding:52px 20px;color:var(--text3)}
.empty-icon{font-size:52px;margin-bottom:14px;display:block}
.empty p{font-style:italic;font-size:14px;line-height:1.7;color:var(--text2)}
#loading-screen{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999;transition:opacity .4s}
#loading-screen.gone{opacity:0;pointer-events:none}
.loading-logo{font-family:'Playfair Display',serif;font-size:36px;font-weight:900;color:var(--text);margin-bottom:6px}
.loading-logo em{color:var(--accent);font-style:normal}
.loading-spinner{width:28px;height:28px;border:2.5px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin-top:20px}


/* â”€â”€ SORT BAR â”€â”€ */
.sort-bar{display:flex;align-items:center;gap:6px;margin-bottom:14px;flex-wrap:wrap}
.sort-label{font-size:11px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.06em;margin-right:2px}
.sort-btn{padding:5px 11px;border-radius:20px;border:1.5px solid var(--border);background:transparent;color:var(--text3);font-family:inherit;font-size:12px;cursor:pointer;transition:all .15s;font-weight:500}
.sort-btn:hover{border-color:var(--accent);color:var(--text)}
.sort-btn.active{border-color:var(--accent);background:var(--accent-d);color:var(--accent);font-weight:600}
/* â”€â”€ READ BADGE â”€â”€ */
.read-badge{display:inline-flex;align-items:center;gap:4px;background:rgba(90,173,110,.18);border:1px solid rgba(90,173,110,.35);color:var(--ok);border-radius:20px;padding:3px 9px;font-size:11px;font-weight:600;margin-top:6px}
.book-read-tick{position:absolute;bottom:6px;right:6px;background:var(--ok);border-radius:50%;width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:10px;border:2px solid var(--bg)}
.recent-read-tick{font-size:12px;color:var(--ok);margin-left:2px;flex-shrink:0}
/* â”€â”€ COVER URL ROW â”€â”€ */
.cover-url-row{display:flex;gap:6px;margin-top:8px;align-items:center}
.cover-url-input{flex:1;background:var(--input);border:1.5px solid var(--border);border-radius:8px;padding:7px 10px;color:var(--text);font-family:inherit;font-size:12px;outline:none;transition:border-color .2s;caret-color:var(--accent)}
.cover-url-input:focus{border-color:var(--accent)}
.cover-url-input::placeholder{color:var(--text3)}
.cover-url-btn{padding:7px 11px;border-radius:8px;border:1.5px solid var(--border);background:var(--card2);color:var(--text);font-family:inherit;font-size:12px;cursor:pointer;transition:all .15s;white-space:nowrap;font-weight:500}
.cover-url-btn:hover{border-color:var(--accent);color:var(--accent)}
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
</style>
</head>
<body>

<div id="loading-screen">
  <div class="loading-logo">ğŸ“š Book <em>Bitches</em></div>
  <div class="loading-spinner"></div>
</div>

<div id="shell">

  <!-- â•â•â•â• SIDEBAR (desktop) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <aside class="sidebar">
    <div class="sidebar-logo">ğŸ“š Book <em>Bitches</em></div>
    <nav class="sidebar-nav">
      <button class="sidebar-btn active" id="snav-home" onclick="navigate('home')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        Home
      </button>
      <button class="sidebar-btn" id="snav-my" onclick="navigate('my')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
        My Shelf
        <span class="sidebar-badge" id="sbadge-my"></span>
      </button>
      <button class="sidebar-btn" id="snav-beth" onclick="navigate('beth')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/><line x1="12" y1="7" x2="12" y2="13"/><line x1="9" y1="10" x2="15" y2="10"/></svg>
        Beth's Shelf
        <span class="sidebar-badge" id="sbadge-beth"></span>
      </button>
      <button class="sidebar-btn" id="snav-settings" onclick="navigate('settings')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l-.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        Settings
      </button>
    </nav>
    <button class="sidebar-fab" onclick="openAddModal()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Add a Book
    </button>
    <div class="sidebar-stats" id="sidebar-stats">Loadingâ€¦</div>
  </aside>

  <!-- â•â•â•â• MAIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="main">

    <div class="header" id="header">
      <div class="logo-row">
        <div class="logo">ğŸ“š Book <em>Bitches</em></div>
        <div class="stats-pill" id="stats-pill">loadingâ€¦</div>
      </div>
      <div class="search-wrap">
        <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input class="search-input" id="search-input" placeholder="Search books or authorsâ€¦" oninput="handleSearch(this.value)" autocomplete="off" spellcheck="false">
        <button class="search-clear" id="search-clear" onclick="clearSearch()">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
    </div>

    <div class="content">
      <div class="firebase-banner" id="firebase-banner"><strong>âš ï¸ Firebase not configured</strong> â€” Paste your config into index.html.</div>

      <!-- HOME -->
      <div class="page active" id="page-home">
        <div class="section-head">
          <div class="section-title">Recently Added</div>
          <div class="section-sub" id="recent-sub">Last 5 books</div>
        </div>
        <div id="recent-list" class="recent-list"></div>
      </div>

      <!-- MY SHELF -->
      <div class="page" id="page-my">
        <div class="section-head">
          <div class="section-title">Connie's Shelf</div>
          <div class="section-sub" id="my-sub">0 books</div>
        </div>
        <div class="sort-bar">
          <span class="sort-label">Sort</span>
          <button class="sort-btn active" id="my-sort-alpha" onclick="setSort('my','alpha')">Aâ€“Z</button>
          <button class="sort-btn" id="my-sort-date" onclick="setSort('my','date')">Date Added</button>
        </div>
        <div id="my-grid" class="books-grid"></div>
      </div>

      <!-- BETH'S SHELF -->
      <div class="page" id="page-beth">
        <div class="section-head">
          <div class="section-title">Beth's Shelf</div>
          <div class="section-sub" id="beth-sub">0 books</div>
        </div>
        <div class="sort-bar">
          <span class="sort-label">Sort</span>
          <button class="sort-btn active" id="beth-sort-alpha" onclick="setSort('beth','alpha')">Aâ€“Z</button>
          <button class="sort-btn" id="beth-sort-date" onclick="setSort('beth','date')">Date Added</button>
        </div>
        <div id="beth-grid" class="books-grid"></div>
      </div>

      <!-- SEARCH -->
      <div class="page" id="page-search">
        <div class="section-head">
          <div class="section-title">Search</div>
          <div class="section-sub" id="search-sub">0 results</div>
        </div>
        <div id="search-results" class="recent-list"></div>
      </div>

      <!-- SETTINGS -->
      <div class="page" id="page-settings">
        <div class="section-head" style="margin-bottom:16px">
          <div class="section-title">Settings</div>
        </div>

        <div class="settings-card">
          <div class="settings-row col">
            <div><div class="settings-label">Theme</div><div class="settings-sub">Pick your vibe</div></div>
            <div class="theme-grid">
              <div class="theme-swatch" id="sw-dark" onclick="setTheme('dark')"><div class="swatch-dot" style="background:linear-gradient(135deg,#14110f 50%,#c17f42 50%)"></div><span class="swatch-label">Dark</span></div>
              <div class="theme-swatch" id="sw-light" onclick="setTheme('light')"><div class="swatch-dot" style="background:linear-gradient(135deg,#faf6f1 50%,#b5702e 50%)"></div><span class="swatch-label">Light</span></div>
              <div class="theme-swatch" id="sw-purple" onclick="setTheme('purple')"><div class="swatch-dot" style="background:linear-gradient(135deg,#0f0c17 50%,#a07de0 50%)"></div><span class="swatch-label">Purple</span></div>
              <div class="theme-swatch" id="sw-green" onclick="setTheme('green')"><div class="swatch-dot" style="background:linear-gradient(135deg,#0c1410 50%,#5aad6e 50%)"></div><span class="swatch-label">Green</span></div>
            </div>
          </div>
        </div>

        <div class="settings-card">
          <div class="settings-row">
            <div><div class="settings-label">Recent books on Home</div><div class="settings-sub">How many to show</div></div>
            <div class="count-btns">
              <button class="count-btn" id="cnt-3" onclick="setRecentCount(3)">3</button>
              <button class="count-btn active" id="cnt-5" onclick="setRecentCount(5)">5</button>
              <button class="count-btn" id="cnt-10" onclick="setRecentCount(10)">10</button>
            </div>
          </div>
        </div>

        <div class="settings-card">
          <div class="settings-row col">
            <div><div class="settings-label">Library Stats</div></div>
            <div class="stats-grid">
              <div class="stat-tile"><div class="stat-num" id="st-total">0</div><div class="stat-label">Total Books</div></div>
              <div class="stat-tile"><div class="stat-num" id="st-mine">0</div><div class="stat-label">Connie's Books</div></div>
              <div class="stat-tile"><div class="stat-num" id="st-beth">0</div><div class="stat-label">Beth's Books</div></div>
              <div class="stat-tile"><div class="stat-num" id="st-last" style="font-size:15px;padding-top:4px">â€”</div><div class="stat-label">Last Added</div></div>
            </div>
          </div>
        </div>

        <div class="settings-card">
          <div class="settings-row">
            <div><div class="settings-label">Export Library</div><div class="settings-sub">Download all books as a spreadsheet</div></div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
              <button class="action-btn" onclick="exportCSV()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                CSV
              </button>
              <button class="action-btn" onclick="exportExcel()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Excel
              </button>
            </div>
          </div>
          <div class="settings-row">
            <div><div class="settings-label">Find Duplicates</div><div class="settings-sub">Books owned by both of you, or added twice</div></div>
            <button class="action-btn warn" onclick="openDupeModal()">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              Scan
            </button>
          </div>
        </div>

        <div class="settings-card">
          <div class="settings-row">
            <div><div class="settings-label">Install App</div><div class="settings-sub">Add to your home screen</div></div>
            <button class="count-btn" id="install-btn" onclick="promptInstall()" style="display:none">Install</button>
            <span id="install-note" class="settings-sub" style="color:var(--ok)"></span>
          </div>
          <div class="settings-row">
            <div><div class="settings-label">Firebase Status</div><div class="settings-sub" id="fb-status-label">Checkingâ€¦</div></div>
          </div>
        </div>
      </div>
    </div><!-- /content -->

    <!-- Mobile nav -->
    <nav class="bottom-nav">
      <button class="nav-btn active" id="nav-home" onclick="navigate('home')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        <span>Home</span>
      </button>
      <button class="nav-btn" id="nav-my" onclick="navigate('my')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
        <span>Connie's</span><span class="nav-badge" id="badge-my"></span>
      </button>
      <button class="nav-btn" id="nav-beth" onclick="navigate('beth')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/><line x1="12" y1="7" x2="12" y2="13"/><line x1="9" y1="10" x2="15" y2="10"/></svg>
        <span>Beth's</span><span class="nav-badge" id="badge-beth"></span>
      </button>
      <button class="nav-btn" id="nav-settings" onclick="navigate('settings')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l-.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        <span>Settings</span>
      </button>
    </nav>
    <button class="fab" onclick="openAddModal()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    </button>
  </div><!-- /main -->
</div><!-- /shell -->

<!-- â•â•â•â• ADD/EDIT MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="book-overlay" onclick="overlayClick(event,'book-overlay')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div class="modal-title" id="modal-title">Add a Book</div>
      <button class="icon-btn" onclick="closeOverlay('book-overlay')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>

    <!-- COVER PREVIEW â€” shows as soon as title+author are filled -->
    <div class="cover-preview-wrap" id="cover-preview-wrap" style="display:none">
      <div class="cover-preview-box" id="cover-preview-box">ğŸ“–
        <img id="cover-preview-img" alt="Cover" style="display:none">
      </div>
      <div class="cover-preview-info">
        <div class="cover-preview-booktitle" id="cover-preview-booktitle"></div>
        <div class="cover-status-row" id="cover-status-row">
          <span id="cover-status-text">Searchingâ€¦</span>
        </div>
        <div class="cover-action-btns">
          <button class="cover-tiny-btn" id="cover-retry-btn" onclick="triggerCoverSearch(true)" style="display:none">â†º Try again</button>
          <button class="cover-tiny-btn muted" id="cover-remove-btn" onclick="removeCover()" style="display:none">âœ• Remove cover</button>
        </div>
        <div class="cover-url-row">
          <input class="cover-url-input" id="cover-url-manual" placeholder="Or paste image URLâ€¦" oninput="onManualUrlInput(this.value)">
          <button class="cover-url-btn" onclick="applyManualUrl()">Use URL</button>
        </div>
      </div>
    </div>

    <input type="hidden" id="edit-id">
    <input type="hidden" id="form-cover-url">

    <div class="form-group">
      <label class="form-label">Title *</label>
      <input class="form-input" id="form-title" placeholder="Book titleâ€¦" maxlength="120" oninput="onTitleInput()">
    </div>
    <div class="form-group">
      <label class="form-label">Author *</label>
      <input class="form-input" id="form-author" placeholder="Author nameâ€¦" maxlength="100" oninput="onAuthorInput()">
    </div>
    <div class="form-group">
      <label class="form-label">Notes <span style="color:var(--text3);font-weight:400;text-transform:none">(optional)</span></label>
      <textarea class="form-input" id="form-notes" placeholder="Thoughts, rating, reviewâ€¦" maxlength="500"></textarea>
    </div>
    <div class="form-group">
      <label class="form-label">Date Added <span style="color:var(--text3);font-weight:400;text-transform:none">(optional)</span></label>
      <input class="form-input" type="date" id="form-date" style="color-scheme:dark;max-width:100%;box-sizing:border-box">
    </div>
    <div class="form-group">
      <label class="form-label">Mark as Read</label>
      <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:2px 0">
        <div style="position:relative;width:44px;height:24px;flex-shrink:0">
          <input type="checkbox" id="form-read" style="opacity:0;width:0;height:0;position:absolute" onchange="updateReadToggle()">
          <div id="read-toggle-track" style="position:absolute;inset:0;border-radius:12px;background:var(--border);transition:background .2s;cursor:pointer" onclick="document.getElementById('form-read').click()"></div>
          <div id="read-toggle-thumb" style="position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:#fff;transition:transform .2s;pointer-events:none"></div>
        </div>
        <span id="read-toggle-label" style="font-size:13px;color:var(--text2)">Not read yet</span>
      </label>
    </div>
    <div class="form-group">
      <label class="form-label">Shelf</label>
      <div class="owner-toggle">
        <button class="owner-btn active" id="own-me" onclick="selectOwner('me')">ğŸ“– Connie</button>
        <button class="owner-btn" id="own-beth" onclick="selectOwner('beth')">ğŸ“— Beth</button>
      </div>
    </div>
    <button class="submit-btn" id="form-submit" onclick="submitBook()" disabled>Add to Shelf</button>
  </div>
</div>

<!-- â•â•â•â• DETAIL MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="detail-overlay" onclick="overlayClick(event,'detail-overlay')">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div class="modal-title" id="detail-shelf-label"></div>
      <button class="icon-btn" onclick="closeOverlay('detail-overlay')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="detail-hero">
      <div class="detail-cover-wrap" id="detail-cover-wrap">ğŸ“–
        <img id="detail-cover-img" alt="Cover" style="display:none;position:absolute;inset:0;width:100%;height:100%;object-fit:cover">
      </div>
      <div class="detail-info">
        <div class="detail-title" id="detail-title"></div>
        <div class="detail-author" id="detail-author"></div>
        <div class="detail-meta" id="detail-date"></div>
      </div>
    </div>
    <div class="detail-notes" id="detail-notes" style="display:none"></div>
    <div class="detail-actions">
      <button class="detail-btn" onclick="editFromDetail()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Edit</button>
      <button class="detail-btn danger" onclick="deleteFromDetail()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg> Remove</button>
    </div>
  </div>
</div>

<!-- â•â•â•â• DELETE CONFIRM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="del-overlay" onclick="overlayClick(event,'del-overlay')" style="align-items:center">
  <div class="confirm-modal">
    <div class="confirm-icon">ğŸ—‘ï¸</div>
    <div class="confirm-title" id="del-title">Remove this book?</div>
    <div class="confirm-sub">This can't be undone.</div>
    <input type="hidden" id="del-id">
    <div class="confirm-btns">
      <button class="confirm-btn" onclick="closeOverlay('del-overlay')">Cancel</button>
      <button class="confirm-btn danger" onclick="confirmDelete()">Remove</button>
    </div>
  </div>
</div>

<!-- â•â•â•â• DUPLICATES MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="dupe-overlay" onclick="overlayClick(event,'dupe-overlay')">
  <div class="dupe-modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div class="modal-title">Duplicate Books</div>
      <button class="icon-btn" onclick="closeOverlay('dupe-overlay')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="width:20px;height:20px"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div id="dupe-list"></div>
  </div>
</div>

<!-- â•â•â•â• TOAST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="toast" id="toast"><div class="toast-dot" id="toast-dot"></div><span id="toast-text">Done!</span></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FIREBASE CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const FIREBASE_CONFIG = {
  apiKey:            "AIzaSyA7bBpqj_gMbIi-9SZ19HJ5tYkHNWD-Ims",
  authDomain:        "book-bitches.firebaseapp.com",
  projectId:         "book-bitches",
  storageBucket:     "book-bitches.firebasestorage.app",
  messagingSenderId: "273694666905",
  appId:             "1:273694666905:web:ab5f560e19f276821b4808"
};

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SPINES=['#E8A598','#A8C5A0','#9DB4C0','#D4A5C9','#F2CC8F','#B5C4B1','#C9B8A8','#8FC1D4','#D4B5C8','#BFCBA8','#F0B8A8','#A8B8D4','#CBAACB','#AAC4C4','#D4C4A0'];
function spineCol(t){let h=0;for(let i=0;i<t.length;i++)h=(h*31+t.charCodeAt(i))&0xffff;return SPINES[h%SPINES.length]}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function norm(s){return(s||'').toLowerCase().replace(/[^a-z0-9]/g,'')}

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let books=[],settings={theme:'dark',recentCount:5},currentPage='home';
let selectedOwner='me',searchQuery='',activeDetailId=null;
let coverSearchTimer=null,deferredInstall=null,db=null;
let shelfSort={my:'alpha',beth:'alpha'};

// â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadSettings(){try{return Object.assign({theme:'dark',recentCount:5},JSON.parse(localStorage.getItem('bb3:settings')))}catch{return{theme:'dark',recentCount:5}}}
function saveSettings(){try{localStorage.setItem('bb3:settings',JSON.stringify(settings))}catch{}}

// â”€â”€ FIREBASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initFirebase(){
  const timeout=setTimeout(()=>{
    if(document.getElementById('loading-screen')){
      document.getElementById('fb-status-label').textContent='âš ï¸ Timed out â€” using local storage';
      loadLocalFallback();
    }
  },5000);

  if(FIREBASE_CONFIG.apiKey==='REPLACE_WITH_YOUR_API_KEY'){
    clearTimeout(timeout);
    document.getElementById('firebase-banner').classList.add('show');
    document.getElementById('fb-status-label').textContent='âš ï¸ Not configured';
    loadLocalFallback();return;
  }
  try{
    const app=initializeApp(FIREBASE_CONFIG);
    db=getFirestore(app);
    document.getElementById('fb-status-label').textContent='Connectingâ€¦';
    onSnapshot(collection(db,'books'),snap=>{
      clearTimeout(timeout);
      books=snap.docs.map(d=>({id:d.id,...d.data()}));
      document.getElementById('fb-status-label').textContent='âœ… Connected â€” syncing live';
      renderAll();hideLoading();
    },err=>{
      clearTimeout(timeout);
      console.error(err);
      document.getElementById('fb-status-label').textContent='âŒ Error â€” check config';
      loadLocalFallback();
    });
  }catch(e){clearTimeout(timeout);console.error(e);loadLocalFallback()}
}
function loadLocalFallback(){try{books=JSON.parse(localStorage.getItem('bb3:books'))||[]}catch{books=[]}renderAll();hideLoading()}
function saveLocal(){try{localStorage.setItem('bb3:books',JSON.stringify(books))}catch{}}
async function addBook(data){
  if(db){try{await addDoc(collection(db,'books'),{...data,dateAdded:serverTimestamp()});return}catch(e){console.error(e)}}
  books.push({...data,id:Date.now().toString(),dateAdded:new Date().toISOString()});saveLocal();renderAll();
}
async function updateBook(id,data){
  if(db){try{await updateDoc(doc(db,'books',id),data);return}catch(e){console.error(e)}}
  books=books.map(b=>b.id===id?{...b,...data}:b);saveLocal();renderAll();
}
async function deleteBook(id){
  if(db){try{await deleteDoc(doc(db,'books',id));return}catch(e){console.error(e)}}
  books=books.filter(b=>b.id!==id);saveLocal();renderAll();
}

// â”€â”€ COVER APIs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const coverCache={};

async function fetchCover(title,author){
  const key=`${title}|${author}`.toLowerCase();
  if(coverCache[key]!==undefined)return coverCache[key];

  // helper â€” validate an image URL is real (not a placeholder 1x1)
  async function checkImg(url){
    try{const r=await fetch(url,{method:'HEAD'});const cl=r.headers.get('content-length');return r.ok&&(!cl||parseInt(cl)>2000)}catch{return false}
  }

  // 1) Google Books â€” try combined query first, then title-only fallback
  async function tryGoogleBooks(query){
    try{
      const res=await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=8&fields=items(volumeInfo(imageLinks,title))`);
      if(!res.ok)return null;
      const d=await res.json();
      if(d.items){
        for(const item of d.items){
          const img=item.volumeInfo?.imageLinks;
          if(img){
            return(img.extraLarge||img.large||img.medium||img.thumbnail||img.smallThumbnail)
              .replace('http://','https://').replace('zoom=1','zoom=3').replace('&edge=curl','');
          }
        }
      }
    }catch(e){}
    return null;
  }
  let url=await tryGoogleBooks(`intitle:${title}+inauthor:${author}`);
  if(!url)url=await tryGoogleBooks(`intitle:${title}`);
  if(url){coverCache[key]=url;return url;}

  // 2) bookcover.longitood.com â€” free Goodreads cover API, no key needed
  try{
    const res=await fetch(`https://bookcover.longitood.com/bookcover?book_title=${encodeURIComponent(title)}&author_name=${encodeURIComponent(author)}`);
    if(res.ok){
      const d=await res.json();
      if(d.url&&d.url.startsWith('http')){coverCache[key]=d.url;return d.url;}
    }
  }catch(e){}

  // 3) Open Library â€” search by title+author, then title alone
  async function tryOpenLibrary(query){
    try{
      const res=await fetch(`https://openlibrary.org/search.json?q=${encodeURIComponent(query)}&limit=5&fields=isbn,cover_i,title`);
      if(!res.ok)return null;
      const d=await res.json();
      if(d.docs){
        for(const doc of d.docs){
          if(doc.cover_i){return `https://covers.openlibrary.org/b/id/${doc.cover_i}-L.jpg`;}
          if(doc.isbn){
            for(const isbn of doc.isbn.slice(0,3)){
              const u=`https://covers.openlibrary.org/b/isbn/${isbn}-L.jpg`;
              if(await checkImg(u))return u;
            }
          }
        }
      }
    }catch(e){}
    return null;
  }
  url=await tryOpenLibrary(`${title} ${author}`);
  if(!url)url=await tryOpenLibrary(title);
  if(url){coverCache[key]=url;return url;}

  // 4) Hardcover via Netlify Function proxy
  try{
    const res=await fetch(`/.netlify/functions/cover?title=${encodeURIComponent(title)}&author=${encodeURIComponent(author)}`);
    if(res.ok){const d=await res.json();if(d.url){coverCache[key]=d.url;return d.url;}}
  }catch(e){}

  coverCache[key]=null;return null;
}

// â”€â”€ DATE HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sortByDate(arr){return[...arr].sort((a,b)=>{const da=a.dateAdded?.toDate?a.dateAdded.toDate():new Date(a.dateAdded||0),db2=b.dateAdded?.toDate?b.dateAdded.toDate():new Date(b.dateAdded||0);return db2-da})}
function fmtDate(v){if(!v)return'â€”';const d=v?.toDate?v.toDate():new Date(v);return d.toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'})}
function fmtShort(v){if(!v)return'â€”';const d=v?.toDate?v.toDate():new Date(v);return d.toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'2-digit'})}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll(){renderStats();renderRecent();renderShelf('my');renderShelf('beth');updateBadges();if(searchQuery)renderSearch()}

function renderStats(){
  const mine=books.filter(b=>b.owner==='me').length,beth=books.filter(b=>b.owner==='beth').length;
  document.getElementById('stats-pill').textContent=`${books.length} books Â· ${mine}+${beth}`;
  document.getElementById('sidebar-stats').textContent=`${books.length} books total\n${mine} mine Â· ${beth} Beth's`;
  document.getElementById('st-total').textContent=books.length;
  document.getElementById('st-mine').textContent=mine;
  document.getElementById('st-beth').textContent=beth;
  const s=sortByDate(books);document.getElementById('st-last').textContent=s[0]?fmtShort(s[0].dateAdded):'â€”';
}

function updateBadges(){
  const mine=books.filter(b=>b.owner==='me').length,beth=books.filter(b=>b.owner==='beth').length;
  [['my',mine],['beth',beth]].forEach(([w,n])=>{
    ['badge-'+w,'sbadge-'+w].forEach(id=>{const el=document.getElementById(id);if(el){el.textContent=n;el.classList.toggle('show',n>0)}});
  });
}

function renderRecent(){
  const list=sortByDate(books).slice(0,settings.recentCount);
  document.getElementById('recent-sub').textContent=`Last ${settings.recentCount} books across both shelves`;
  const el=document.getElementById('recent-list');
  el.innerHTML=list.length?list.map(recentItemHTML).join(''):`<div class="empty"><span class="empty-icon">ğŸ“–</span><p>Shelves empty! Tap <strong>+</strong> to add your first book.</p></div>`;
  lazyLoadCovers(list);
}

function renderShelf(who){
  const owner=who==='my'?'me':'beth';
  const sort=shelfSort[who]||'alpha';
  const filtered=[...books.filter(b=>b.owner===owner)].sort((a,b)=>{
    if(sort==='alpha')return a.title.localeCompare(b.title);
    // date: newest first
    const da=a.dateAdded?.toDate?a.dateAdded.toDate():new Date(a.dateAdded||0);
    const db2=b.dateAdded?.toDate?b.dateAdded.toDate():new Date(b.dateAdded||0);
    return db2-da;
  });
  document.getElementById(who+'-sub').textContent=`${filtered.length} book${filtered.length!==1?'s':''}`;
  const grid=document.getElementById(who+'-grid');
  grid.innerHTML=filtered.length?filtered.map(bookCardHTML).join(''):`<div class="empty" style="grid-column:1/-1"><span class="empty-icon">${who==='my'?'ğŸ“š':'ğŸ“—'}</span><p>${who==='my'?'Nothing on Connie\'s shelf yet.':'Nothing on Beth\'s shelf yet.'}</p></div>`;
  lazyLoadCovers(filtered);
}
window.setSort=function(who,sort){
  shelfSort[who]=sort;
  // Update button states
  ['alpha','date'].forEach(s=>{
    const btn=document.getElementById(`${who}-sort-${s}`);
    if(btn)btn.classList.toggle('active',s===sort);
  });
  renderShelf(who);
};

function renderSearch(){
  const q=searchQuery.toLowerCase();
  const results=books.filter(b=>b.title?.toLowerCase().includes(q)||b.author?.toLowerCase().includes(q));
  document.getElementById('search-sub').textContent=`${results.length} result${results.length!==1?'s':''}`;
  const el=document.getElementById('search-results');
  el.innerHTML=results.length?results.map(recentItemHTML).join(''):`<div class="empty"><span class="empty-icon">ğŸ”</span><p>No books match "${esc(searchQuery)}".</p></div>`;
  lazyLoadCovers(results);
}

function lazyLoadCovers(list){
  list.forEach(async b=>{
    if(b.coverUrl)return;
    const url=await fetchCover(b.title,b.author);
    if(!url)return;
    // Update recent/search view
    const rv=document.getElementById(`rv-${b.id}`);
    if(rv){rv.innerHTML=`<img src="${esc(url)}" style="width:100%;height:100%;object-fit:cover" alt="">`;rv.style.display='block';const strip=rv.previousElementSibling;if(strip?.classList?.contains('recent-spine-strip'))strip.style.display='none'}
    // Update grid card view
    const cv=document.getElementById(`cv-${b.id}`);
    if(cv){cv.outerHTML=`<img class="book-cover-img" src="${esc(url)}" alt="${esc(b.title)}" loading="lazy">`}
  });
}

function recentItemHTML(b){
  const col=spineCol(b.title),who=b.owner==='beth'?'Beth':'Connie';
  const coverHtml=b.coverUrl
    ?`<img src="${esc(b.coverUrl)}" alt="" style="width:100%;height:100%;object-fit:cover">`
    :`<div class="recent-spine-strip" style="background:${col}"></div><div id="rv-${b.id}" style="display:none;position:absolute;inset:0"></div>`;
  return`<div class="recent-item" onclick="openDetail('${b.id}')">
    <div class="recent-cover">${coverHtml}</div>
    <div class="recent-info">
      <div class="recent-title">${esc(b.title)}</div>
      <div class="recent-author">${esc(b.author)}</div>
      ${b.notes?`<div class="recent-note">"${esc(b.notes)}"</div>`:''}
    </div>
    <div class="recent-meta"><div class="recent-who">${who}${b.isRead?' <span class="recent-read-tick">âœ“</span>':''}</div><div class="recent-date">${fmtShort(b.dateAdded)}</div></div>
    <div class="recent-btns" onclick="event.stopPropagation()">
      <button class="icon-btn" data-action="edit" data-id="${b.id}" title="Edit"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
      <button class="icon-btn del" data-action="del" data-id="${b.id}" title="Delete"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
    </div>
  </div>`;
}

function bookCardHTML(b){
  const col=spineCol(b.title);
  const inner=b.coverUrl
    ?`<img class="book-cover-img" src="${esc(b.coverUrl)}" alt="${esc(b.title)}" loading="lazy" onerror="this.replaceWith(Object.assign(document.createElement('div'),{className:'book-cover-fallback',innerHTML:'<div class=spine-stripe style=background:${col}></div><div><div class=fallback-title>${esc(b.title)}</div><div class=fallback-author>${esc(b.author)}</div></div>'}))">`
    :`<div class="book-cover-fallback" id="cv-${b.id}"><div class="spine-stripe" style="background:${col}"></div><div><div class="fallback-title">${esc(b.title)}</div><div class="fallback-author">${esc(b.author)}</div></div></div>`;
  return`<div class="book-card" onclick="openDetail('${b.id}')">
    ${b.owner==='beth'?'<div class="book-owner-dot"></div>':''}${b.isRead?'<div class="book-read-tick">âœ“</div>':''}
    <div class="book-cover-wrap">${inner}</div>
    <div class="book-info">
      <div class="book-info-title">${esc(b.title)}</div>
      <div class="book-info-author">${esc(b.author)}</div>
      <div class="book-info-date">${fmtShort(b.dateAdded)}</div>
    </div>
  </div>`;
}

// â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.navigate=function(page){
  if(page!=='search'&&searchQuery){clearSearch();return}
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn,.sidebar-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+page)?.classList.add('active');
  document.getElementById('nav-'+page)?.classList.add('active');
  document.getElementById('snav-'+page)?.classList.add('active');
  currentPage=page;window.scrollTo(0,0);
};
window.handleSearch=function(val){
  searchQuery=val.trim().toLowerCase();
  document.getElementById('search-clear').classList.toggle('vis',!!val);
  if(searchQuery){
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.nav-btn,.sidebar-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById('page-search').classList.add('active');
    renderSearch();
  }else clearSearch();
};
window.clearSearch=function(){
  searchQuery='';document.getElementById('search-input').value='';
  document.getElementById('search-clear').classList.remove('vis');
  navigate(currentPage==='search'?'home':currentPage);
};

// â”€â”€ DETAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.openDetail=function(id){
  const b=books.find(x=>x.id===id);if(!b)return;
  activeDetailId=id;
  document.getElementById('detail-shelf-label').textContent=b.owner==='beth'?"Beth's Shelf":"Connie's Shelf";
  document.getElementById('detail-title').textContent=b.title;
  document.getElementById('detail-author').textContent=b.author;
  document.getElementById('detail-date').textContent='Added '+fmtDate(b.dateAdded);
  // Show/hide read badge
  let readBadgeEl=document.getElementById('detail-read-badge');
  if(!readBadgeEl){readBadgeEl=document.createElement('div');readBadgeEl.id='detail-read-badge';document.getElementById('detail-date').after(readBadgeEl)}
  readBadgeEl.innerHTML=b.isRead?'<span class="read-badge">âœ“ Read</span>':'';
  const notesEl=document.getElementById('detail-notes');
  if(b.notes){notesEl.textContent=`"${b.notes}"`;notesEl.style.display='block'}else notesEl.style.display='none';
  const img=document.getElementById('detail-cover-img');
  const coverUrl=b.coverUrl||coverCache[`${b.title}|${b.author}`.toLowerCase()];
  if(coverUrl){img.src=coverUrl;img.style.display='block'}
  else{img.style.display='none';fetchCover(b.title,b.author).then(url=>{if(url){img.src=url;img.style.display='block'}})}
  openOverlay('detail-overlay');
};
window.editFromDetail=function(){closeOverlay('detail-overlay');setTimeout(()=>openEditModal(activeDetailId),200)};
window.deleteFromDetail=function(){closeOverlay('detail-overlay');const b=books.find(x=>x.id===activeDetailId);if(b)setTimeout(()=>openDelModal(activeDetailId,b.title),200)};

// â”€â”€ ADD/EDIT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.openAddModal=function(){
  document.getElementById('modal-title').textContent='Add a Book';
  document.getElementById('edit-id').value='';
  ['form-title','form-author','form-notes','form-date','cover-url-manual'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('form-read').checked=false;updateReadToggle();
  document.getElementById('form-cover-url').value='';
  document.getElementById('cover-preview-wrap').style.display='none';
  selectOwner(currentPage==='beth'?'beth':'me');
  document.getElementById('form-submit').textContent='Add to Shelf';
  document.getElementById('form-submit').disabled=true;
  openOverlay('book-overlay');
  setTimeout(()=>document.getElementById('form-title').focus(),320);
};

window.openEditModal=function(id){
  const b=books.find(x=>x.id===id);if(!b)return;
  document.getElementById('modal-title').textContent='Edit Book';
  document.getElementById('edit-id').value=id;
  document.getElementById('form-title').value=b.title;
  document.getElementById('form-author').value=b.author;
  document.getElementById('form-notes').value=b.notes||'';
  // Set date field
  const bDate=b.dateAdded?.toDate?b.dateAdded.toDate():b.dateAdded?new Date(b.dateAdded):null;
  document.getElementById('form-date').value=bDate?bDate.toISOString().split('T')[0]:'';
  // Set read toggle
  document.getElementById('form-read').checked=!!b.isRead;updateReadToggle();
  document.getElementById('cover-url-manual').value='';
  document.getElementById('form-cover-url').value=b.coverUrl||'';
  selectOwner(b.owner);
  document.getElementById('form-submit').textContent='Save Changes';
  document.getElementById('form-submit').disabled=false;
  openOverlay('book-overlay');
  // Defer cover search so modal animation doesn't block
  setTimeout(()=>{try{if(b.coverUrl)showCoverPreview(b.coverUrl,'Saved cover',true);else{showCoverPanel();triggerCoverSearch(false);}}catch(e){console.warn('cover search error',e);}},100);
};

window.selectOwner=function(o){
  selectedOwner=o;
  document.getElementById('own-me').classList.toggle('active',o==='me');
  document.getElementById('own-beth').classList.toggle('active',o==='beth');
};

// Cover preview state machine
function showCoverPanel(){document.getElementById('cover-preview-wrap').style.display='flex'}

function showCoverPreview(url,statusText,found){
  showCoverPanel();
  const title=document.getElementById('form-title').value.trim();
  document.getElementById('cover-preview-booktitle').textContent=title;
  const statusRow=document.getElementById('cover-status-row');
  const statusTextEl=document.getElementById('cover-status-text');
  const img=document.getElementById('cover-preview-img');
  const retryBtn=document.getElementById('cover-retry-btn');
  const removeBtn=document.getElementById('cover-remove-btn');

  statusTextEl.textContent=statusText;
  // Remove old spinner if any
  const oldSpinner=statusRow.querySelector('.mini-spinner');if(oldSpinner)oldSpinner.remove();

  if(url){
    img.src=url;img.style.display='block';
    document.getElementById('cover-preview-box').textContent=''; // remove emoji
    statusRow.className='cover-status-row found';
    retryBtn.style.display='none';removeBtn.style.display='block';
  }else if(statusText.toLowerCase().includes('search')){
    img.style.display='none';
    document.getElementById('cover-preview-box').textContent='ğŸ“–';
    statusRow.className='cover-status-row searching';
    const sp=document.createElement('div');sp.className='mini-spinner';statusRow.prepend(sp);
    retryBtn.style.display='none';removeBtn.style.display='none';
  }else{
    img.style.display='none';
    document.getElementById('cover-preview-box').textContent='ğŸ“–';
    statusRow.className='cover-status-row';
    retryBtn.style.display='block';removeBtn.style.display='none';
  }
}

window.onTitleInput=function(){
  updateSubmitBtn();
  const title=document.getElementById('form-title').value.trim();
  const author=document.getElementById('form-author').value.trim();
  if(title)showCoverPanel();
  document.getElementById('cover-preview-booktitle').textContent=title;
  if(title&&author){clearTimeout(coverSearchTimer);coverSearchTimer=setTimeout(()=>triggerCoverSearch(false),900)}
};
window.onAuthorInput=function(){
  updateSubmitBtn();
  const title=document.getElementById('form-title').value.trim();
  const author=document.getElementById('form-author').value.trim();
  if(title&&author){clearTimeout(coverSearchTimer);coverSearchTimer=setTimeout(()=>triggerCoverSearch(false),900)}
};

function updateSubmitBtn(){
  const t=document.getElementById('form-title').value.trim(),a=document.getElementById('form-author').value.trim();
  document.getElementById('form-submit').disabled=!(t&&a);
}

window.triggerCoverSearch=async function(force=false){
  const title=document.getElementById('form-title').value.trim();
  const author=document.getElementById('form-author').value.trim();
  if(!title||!author)return;
  const existing=document.getElementById('form-cover-url').value;
  if(existing&&!force)return; // don't re-search if we already have one
  if(force)delete coverCache[`${title}|${author}`.toLowerCase()];
  showCoverPreview(null,'Searching for coverâ€¦',false);
  const url=await fetchCover(title,author);
  if(url){document.getElementById('form-cover-url').value=url;showCoverPreview(url,'âœ“ Cover found',true)}
  else{document.getElementById('form-cover-url').value='';showCoverPreview(null,'No cover found',false)}
};


window.updateReadToggle=function(){
  const checked=document.getElementById('form-read').checked;
  document.getElementById('read-toggle-track').style.background=checked?'var(--ok)':'var(--border)';
  document.getElementById('read-toggle-thumb').style.transform=checked?'translateX(20px)':'translateX(0)';
  document.getElementById('read-toggle-label').textContent=checked?'âœ“ Read':'Not read yet';
};
window.onManualUrlInput=function(val){
  // Live preview as they type a URL
  if(val.startsWith('http')){
    const img=document.getElementById('cover-preview-img');
    img.src=val;img.style.display='block';
    document.getElementById('cover-preview-box').textContent='';
  }
};
window.applyManualUrl=function(){
  const val=document.getElementById('cover-url-manual').value.trim();
  if(!val)return;
  document.getElementById('form-cover-url').value=val;
  const img=document.getElementById('cover-preview-img');
  img.src=val;img.style.display='block';
  document.getElementById('cover-preview-box').textContent='';
  document.getElementById('cover-status-text').textContent='âœ“ Custom cover set';
  document.getElementById('cover-status-row').className='cover-status-row found';
  document.getElementById('cover-retry-btn').style.display='none';
  document.getElementById('cover-remove-btn').style.display='block';
  showCoverPanel();
  showToast('Cover updated!','ok');
};

window.removeCover=function(){
  document.getElementById('form-cover-url').value='';
  document.getElementById('cover-preview-img').style.display='none';
  document.getElementById('cover-preview-img').src='';
  document.getElementById('cover-preview-box').textContent='ğŸ“–';
  showCoverPreview(null,'No cover â€” will use coloured spine',false);
};

window.submitBook=async function(){
  const title=document.getElementById('form-title').value.trim();
  const author=document.getElementById('form-author').value.trim();
  if(!title||!author)return;
  const notes=document.getElementById('form-notes').value.trim();
  const coverUrl=document.getElementById('form-cover-url').value;
  const editId=document.getElementById('edit-id').value;
  document.getElementById('form-submit').disabled=true;
  document.getElementById('form-submit').textContent='Savingâ€¦';
  const dateVal=document.getElementById('form-date').value;
  const isRead=document.getElementById('form-read').checked;
  const data={title,author,notes,owner:selectedOwner,coverUrl,isRead};
  if(dateVal)data.dateAdded=new Date(dateVal).toISOString();
  if(editId){
    // For updates, pass dateAdded if user set it
    if(dateVal&&db){try{const {Timestamp}=await import('https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js');data.dateAdded=Timestamp.fromDate(new Date(dateVal))}catch{}}
    await updateBook(editId,data);showToast('Book updated!','ok');
  }else{await addBook(data);showToast('Added to shelf! ğŸ“š','ok')}
  closeOverlay('book-overlay');
};

// â”€â”€ DELETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.openDelModal=function(id,title){document.getElementById('del-id').value=id;document.getElementById('del-title').textContent=`Remove "${title}"?`;openOverlay('del-overlay')};
window.confirmDelete=async function(){const id=document.getElementById('del-id').value;await deleteBook(id);if(activeDetailId===id)activeDetailId=null;closeOverlay('del-overlay');showToast('Book removed.','del')};

// â”€â”€ OVERLAYS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.openOverlay=function(id){document.getElementById(id).classList.add('open');document.body.style.overflow='hidden'};
window.closeOverlay=function(id){document.getElementById(id).classList.remove('open');document.body.style.overflow=''};
window.overlayClick=function(e,id){if(e.target===document.getElementById(id))closeOverlay(id)};

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let toastTimer;
window.showToast=function(msg,type=''){
  clearTimeout(toastTimer);
  document.getElementById('toast-text').textContent=msg;
  document.getElementById('toast-dot').className='toast-dot '+(type||'');
  document.getElementById('toast').classList.add('show');
  toastTimer=setTimeout(()=>document.getElementById('toast').classList.remove('show'),2600);
};

// â”€â”€ THEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.setTheme=function(t){settings.theme=t;saveSettings();applyTheme(t)};
function applyTheme(t){
  document.body.className=t==='dark'?'':t;
  ['dark','light','purple','green'].forEach(n=>document.getElementById('sw-'+n)?.classList.toggle('active',n===t));
  document.querySelector('meta[name="theme-color"]')?.setAttribute('content',{dark:'#c17f42',light:'#b5702e',purple:'#a07de0',green:'#5aad6e'}[t]);
}
window.setRecentCount=function(n){settings.recentCount=n;saveSettings();[3,5,10].forEach(x=>document.getElementById('cnt-'+x).classList.toggle('active',x===n));renderRecent()};

// â”€â”€ EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.exportCSV=function(){
  const header=['Title','Author','Shelf','Date Added','Notes'];
  const rows=sortByDate(books).map(b=>{
    const d=b.dateAdded?.toDate?b.dateAdded.toDate():new Date(b.dateAdded||0);
    return[b.title,b.author,b.owner==='me'?'Connie':"Beth's",d.toLocaleDateString('en-GB'),b.notes||'']
      .map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',');
  });
  const csv=[header.join(','),...rows].join('\n');
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8'}); // BOM for Excel
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='book-bitches.csv';a.click();
  showToast('CSV downloaded! ğŸ“Š','ok');
};

window.exportExcel=async function(){
  // Load SheetJS on demand for a proper .xlsx file
  if(!window.XLSX){
    await new Promise((resolve,reject)=>{
      const s=document.createElement('script');
      s.src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
      s.onload=resolve;s.onerror=()=>{showToast('Could not load Excel library','del');reject()};
      document.head.appendChild(s);
    }).catch(()=>null);
    if(!window.XLSX)return;
  }
  // Build rows with all app data
  const rows=[['Title','Author','Shelf','Date Added','Notes','Read','Cover URL']];
  sortByDate(books).forEach(b=>{
    const d=b.dateAdded?.toDate?b.dateAdded.toDate():new Date(b.dateAdded||0);
    rows.push([
      b.title||'',
      b.author||'',
      b.owner==='me'?'Connie':"Beth's",
      d.toLocaleDateString('en-GB'),
      b.notes||'',
      b.isRead?'Yes':'No',
      b.coverUrl||''
    ]);
  });
  const ws=XLSX.utils.aoa_to_sheet(rows);
  ws['!cols']=[{wch:40},{wch:25},{wch:10},{wch:14},{wch:50},{wch:6},{wch:60}];
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Books');
  XLSX.writeFile(wb,'book-bitches.xlsx');
  showToast(`Exported ${books.length} books as .xlsx! ğŸ“Š`,'ok');
};

// â”€â”€ DUPLICATES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.openDupeModal=function(){
  const dupeGroups=[];
  const seen={};

  // Group all books by normalised title
  books.forEach(b=>{
    const key=norm(b.title);
    if(!seen[key])seen[key]=[];
    seen[key].push(b);
  });

  Object.values(seen).forEach(group=>{
    if(group.length>1)dupeGroups.push(group);
  });

  const el=document.getElementById('dupe-list');
  if(!dupeGroups.length){
    el.innerHTML='<div class="no-dupes">ğŸ‰ No duplicates found! Your shelves are clean.</div>';
    openOverlay('dupe-overlay');return;
  }

  el.innerHTML=dupeGroups.map(group=>{
    const title=group[0].title;
    const hasCross=group.some(b=>b.owner==='me')&&group.some(b=>b.owner==='beth');
    const tag=hasCross?'on both shelves':'added multiple times';
    const rows=group.map(b=>`
      <div class="dupe-row">
        <div class="dupe-row-info">
          <div class="dupe-row-who">${b.owner==='me'?'ğŸ“– Connie\'s shelf':'ğŸ“— Beth\'s shelf'}</div>
          <div class="dupe-row-meta">${esc(b.author)} Â· Added ${fmtShort(b.dateAdded)}</div>
        </div>
        <button class="dupe-del-btn" onclick="deleteDupe('${b.id}','${esc(title).replace(/'/g,'&#39;')}')">Remove</button>
      </div>`).join('');
    return`<div class="dupe-group">
      <div class="dupe-group-label">ğŸ“– ${esc(title)} <span style="font-size:12px;color:var(--text3);font-weight:400">â€” ${tag}</span></div>
      ${rows}
    </div>`;
  }).join('');

  openOverlay('dupe-overlay');
};

window.deleteDupe=async function(id,title){
  await deleteBook(id);
  showToast(`Removed "${title}"`, 'del');
  openDupeModal(); // refresh the list
};

// â”€â”€ SCROLL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('scroll',()=>document.getElementById('header').classList.toggle('scrolled',window.scrollY>8),{passive:true});

// â”€â”€ KEYBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ EVENT DELEGATION for edit/delete buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('click',e=>{
  const btn=e.target.closest('[data-action]');
  if(!btn)return;
  e.stopPropagation();
  const id=btn.dataset.id;
  if(btn.dataset.action==='edit')openEditModal(id);
  if(btn.dataset.action==='del'){const b=books.find(x=>x.id===id);if(b)openDelModal(id,b.title);}
});

document.addEventListener('keydown',e=>{
  if(e.key==='Escape')['book-overlay','detail-overlay','del-overlay','dupe-overlay'].forEach(closeOverlay);
  if(e.key==='Enter'&&document.getElementById('book-overlay').classList.contains('open')){
    const t=document.getElementById('form-title').value.trim(),a=document.getElementById('form-author').value.trim();
    if(t&&a)submitBook();
  }
});

// â”€â”€ PWA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredInstall=e;document.getElementById('install-btn').style.display='inline-flex'});
window.promptInstall=async function(){if(!deferredInstall)return;deferredInstall.prompt();const r=await deferredInstall.userChoice;if(r.outcome==='accepted'){document.getElementById('install-btn').style.display='none';document.getElementById('install-note').textContent='âœ… Installed!'}deferredInstall=null};
window.addEventListener('appinstalled',()=>{document.getElementById('install-btn').style.display='none';document.getElementById('install-note').textContent='âœ… Installed';showToast('App installed! ğŸ‰','ok')});
if('serviceWorker'in navigator)navigator.serviceWorker.register('sw.js').catch(console.error);

// â”€â”€ LOADING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function hideLoading(){const ls=document.getElementById('loading-screen');if(!ls)return;ls.classList.add('gone');setTimeout(()=>{if(ls.parentNode)ls.remove()},400)}

// â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
settings=loadSettings();
applyTheme(settings.theme);
[3,5,10].forEach(n=>document.getElementById('cnt-'+n).classList.toggle('active',n===settings.recentCount));
initFirebase();
</script>
</body>
</html>